---
title: "Resolvendo problema de Negócio"
date: ""
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# pacotes utilizados
library(magrittr)
library(patchwork)
```

## Entendendo o Problema

Há um aumento na quantidade de entregas pelo APP, e consequentemente um decaimento
na avaliação dos clientes. Deseja-se descobrir os motivos do decaimento e sugerir alguma melhoria
baseada em dados.


## Conhecendo a base


**Variáveis**


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
df_entregas <- readRDS("data/df_entrega.rds")

#paleta de cores
source("R/temas_graficos.R")
cores <- data.frame(azul_escuro = "#00398F", azul_medio = "#0790E3", azul_claro = "#14D7FA",
                       verde_bebe = "#07E3D1", verde_claro = "#08FBAC")
cordegrade <- colorRampPalette(c("#00398F", "#08FBAC"))

# caracteres
df_entregas %>%
  dplyr::select(where(is.character)) %>% 
    skimr::skim() %>%
      knitr::kable(caption = "Caractéres")

# Fatores
df_entregas %>%
  dplyr::select(where(is.factor)) %>% 
    skimr::skim() %>%
      knitr::kable(caption = "Fatores")

# Quantittivas
df_entregas %>%
  dplyr::select(where(is.numeric)) %>% 
    skimr::skim() %>%
      knitr::kable(caption = "Quantitativas")

# data
df_entregas %>%
  dplyr::select(where(lubridate::is.POSIXct)) %>% 
    skimr::skim() %>%
      knitr::kable(caption = "Data")


```



**Informações**

- Todos os pedidos analisados são de 2017

- As notas de avaliação variam de 1 a 5, sendo -1 os clientes que não responderam e NA os clientes que não receberam a avaliação

- Existe uma classificação de acordo com as notas dos clientes, que seguem as seguintes regras:
  
  * Ruim: Notas entre 1 e 3
  * Medio: Notas igual a 4
  * Bom: Notas igual a 5
  
- Houve um atualização no portal de entregas em meados de Junho/Julho 

- Houve um investimento em comeciais para a empresa ficar mais conhecida em meados de Julho/Agora

## Primeiras Análises

**Análise do Cenário da empresa**

Agora faremos as primeiras análises da nossa base, expondo o cenário que temos da mesma:

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.dim= c(10,7)}

# quantiddde de pedidos por mes
g1 <- df_entregas %>% 
  dplyr::count(MES_REF) %>% 
    ggplot2::ggplot() +
      ggplot2::geom_line(ggplot2::aes(x = MES_REF, y = n), color = cores$verde_claro, size = 0.8) +
        ggplot2::geom_label(ggplot2::aes(x = MES_REF, y = n, label = n),
                            size = 2.5,  fill = cores$azul_escuro, color = "white", show.legend = FALSE) +
          ggplot2::labs(title = "Volume de Pedidos por mês") +
            ggplot2::scale_x_date(date_labels = "%b", date_breaks = "1 month") +
              tema_semest_linha()


# faturamento por mês
g2 <- df_entregas %>% 
  dplyr::group_by(MES_REF) %>%
    dplyr::summarise(
      Faturamento_total = sum(VALOR_PEDIDO)
    ) %>% 
      ggplot2::ggplot() +
        ggplot2::geom_line(ggplot2::aes(x = MES_REF, y = Faturamento_total), color = cores$verde_claro, size = 0.8) +
          ggplot2::geom_label(ggplot2::aes(x = MES_REF, y = Faturamento_total, 
                                           label = paste("R$", round(Faturamento_total, 0), sep = " ")),
                              size = 2.5,  fill = cores$azul_escuro, color = "white", show.legend = FALSE) +
            ggplot2::labs(title = "Faturamento total por mês") +
              ggplot2::scale_x_date(date_labels = "%b", date_breaks = "1 month") +
                tema_semest_linha()


# nota avaliacao poe mes
g3 <- df_entregas %>% 
  dplyr::group_by(MES_REF) %>%
    dplyr::summarise(
      Media_nota = round(mean(NOTA_ENTREGA, na.rm = TRUE),1)
    ) %>% 
    ggplot2::ggplot() +
      ggplot2::geom_line(ggplot2::aes(x = MES_REF, y = Media_nota), color = cores$verde_claro, size = 0.8) +
        ggplot2::geom_label(ggplot2::aes(x = MES_REF, y = Media_nota, label = Media_nota),
                            size = 2.5,  fill = cores$azul_escuro, color = "white", show.legend = FALSE) +
          ggplot2::labs(title = "Media de Avaliação por mês") +
            ggplot2::scale_x_date(date_labels = "%b", date_breaks = "1 month") +
              tema_semest_linha()

# entregas por estado
df_map <- readRDS("data/df_map.rds")

g4 <- df_map %>% 
  ggplot2::ggplot() +
    ggplot2::geom_sf(ggplot2::aes(fill = qtd_entrega), size=.15) +
      ggplot2::geom_sf_text(ggplot2::aes(label = abbrev_state, color = qtd_entrega),
                  size = 2, show.legend = FALSE) +
        ggplot2::labs(title = "Volume de entregas por estado") +
          ggplot2::theme_void() +
            ggplot2::scale_fill_gradient(name = "Volume de Entregas",
                                         low = cores$verde_claro, high = cores$azul_escuro, na.value = "#d6d2d2") +
              ggplot2::scale_color_gradient(low = cores$azul_escuro, high = "white", na.value = "black")

g1 / g3 / g2 
g4

```



- A partir de Junho, há um aumento considerável na quantidade de entregas, e a partir de Setembro, há um aumento repentino na quantidade de entregas 

- O faturamento da empresa está crescendo no deccorrer dos meses, tendo um maior destaque no mês de Julho

- Há uma queda brusca mês de Julho quanto as avaliações dos clientes 

- O Estado de São Paulo é onde ocorre a maioria das entregas, sendo que a empresa atua em outros quatro Estados (Ceará, Minas Gerais, Paraná e Rio de Janeiro)


Continuando as análises, vamos agora tratar de de questões de processos de entrega:

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.dim= c(10,15)}
source("R/funcao_graficos.R")

#percentual notas de entrega
g1 <- df_entregas %>%
  dplyr::mutate(
    NOTA_ENTREGA = as.factor(NOTA_ENTREGA)
  ) %>%
  grafico_barras(data = ., NOTA_ENTREGA, "Notas", "Percentual por nota de avaliação")


# percentual por classe
g2 <- df_entregas %>% 
  grafico_barras(CLASSE, "Classes", " Percentua por Classe")  


# percentual por meio de pagamento
g3 <- df_entregas %>% 
  grafico_barras(TIPO_PAGAMENTO, "Meios de Pagamentos", "Percentual por meio de pagamento")

# turno da entrega
g4 <- df_entregas %>% 
  grafico_barras(TURNO, "Turnos", "Percentual por turnos de entrega")

# tipo de entrega
g5 <- df_entregas %>% 
  grafico_barras(TIPO_ENTREGA, "Tipo de Entrega", "Percentual por tipo de entrega")

# dia da semana 
g6 <- df_entregas %>% 
  grafico_barras(DIA, "Dias da semana", "Percentual por dia da semana")


(g1 + g2) / (g3 + g4) / ( g5 + g6)


```


Já conseguimos enxergar alguns ponstos  de atençãp no processo de entregas, são estes:

- Existe um percentual muito alto de pedidos que não receberam a avaliação após a entrega do produto

- A maioria dos clientes respondentes classifica a entrega como Boa

- Existe um grande percentual de meios de pagamentos não informados

- Os turnos da tarde e noite são os que possuem maior colune de entreda

- Quase 90% dos clientes recebe o pedido, sendo este o tipo de entrega mais frequente

- Sexta, Sábado e Domingo são os dias de maior volume de entregas


Agora vamos tentar aprofundar nossa análise atacando os pontos levantados anteriormente:

**Os problemas da não informação de avaliação e métodos de pagamento:**

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.dim= c(10,4)}

df_entregas %>%
  dplyr::filter(CLASSE == 'Sem Informação') %>% 
    grafico_barras(MES_REF, "Meses", "Percentual de pedidos que não receberam avaliação por mês") +
      ggplot2::scale_x_date(date_labels = "%b", date_breaks = "1 month")


df_entregas %>%
  dplyr::filter(CLASSE == 'Sem Informação') %>%
    dplyr::count(ESTADO, MES) %>% 
      ggplot2::ggplot(ggplot2::aes(x = MES, y = n)) +
        ggplot2::geom_col(ggplot2::aes(fill = ESTADO), show.legend = FALSE) +
          ggplot2::scale_fill_manual(values = cordegrade(5)) +
            ggplot2::theme(
              panel.background = ggplot2::element_blank(), 
              panel.border = ggplot2::element_blank(),
              axis.title.y = ggplot2::element_blank(),
              axis.text.y = ggplot2::element_blank(),
              axis.ticks.y = ggplot2::element_blank()
            ) +
              ggplot2::facet_wrap(~ESTADO)


(df_entregas %>%
  dplyr::filter(CLASSE == 'Sem Informação') %>% 
    dplyr::group_by(TIPO_PAGAMENTO, MES_REF) %>% 
      dplyr::summarise(
        Quantidade = dplyr::n()
      ) %>% 
        ggplot2::ggplot() +
          ggplot2::geom_line(ggplot2::aes(x = MES_REF, y = Quantidade, group = TIPO_PAGAMENTO, color = TIPO_PAGAMENTO)) +
            ggplot2::scale_color_manual(name = "Tipo de Pagamento", 
                          values = cordegrade(4)) +
              ggplot2::scale_x_date(date_labels = "%b", date_breaks = "1 month") +
                tema_semest_linha()) %>% 
  plotly::ggplotly(height = 250, width = 1000)

(df_entregas %>%
  dplyr::filter(CLASSE == 'Sem Informação') %>% 
    dplyr::group_by(TURNO, MES_REF) %>% 
      dplyr::summarise(
        Quantidade = dplyr::n()
      ) %>% 
        ggplot2::ggplot() +
          ggplot2::geom_line(ggplot2::aes(x = MES_REF, y = Quantidade, group = TURNO, color = TURNO)) +
            ggplot2::scale_color_manual(name = "Turno", 
                          values = cordegrade(4)) +
              ggplot2::scale_x_date(date_labels = "%b", date_breaks = "1 month") +
                tema_semest_linha()) %>% 
  plotly::ggplotly(height = 250, width = 1000)
  

(df_entregas %>%
  dplyr::filter(CLASSE == 'Sem Informação') %>% 
    dplyr::group_by(DIA, MES_REF) %>% 
      dplyr::summarise(
        Quantidade = dplyr::n()
      ) %>% 
        ggplot2::ggplot() +
          ggplot2::geom_line(ggplot2::aes(x = MES_REF, y = Quantidade, group = DIA, color = DIA)) +
            ggplot2::scale_color_manual(name = "Dia", values = cordegrade(7)) +
              ggplot2::scale_x_date(date_labels = "%b", date_breaks = "1 month") +
                tema_semest_linha()) %>% 
  plotly::ggplotly(height = 350, width = 1000)


```

Com os gráficos acima pudemos perceber:

- A partir do mês de Junho, onde houve atualização de plataforma, o número de pedidos que não receberam avaliações cresceu

- Os pedidos sem informação de pagamento foram resolvidos em Julho

- Em momento e local de maior quantidade de pedidos, são onde se concentram também os volumes de pedidos sem recebeimento de avaliação, que são os turnos da tarde e noite, nos dias sexta, sábado e domingo e no estado de São Paulo.


**Avaliando os entregadores**

Agora vamos avaliar os indicadores quanto aos entregadores:

Ao todo, nossa base possui `r length(unique(df_entregas$ID_ENTREGADOR))` entregadores.

```{r echo=FALSE,message=FALSE, warning=FALSE, fig.align='center', fig.dim= c(10,4)}

df_entregas %>%
  dplyr::distinct(ID_ENTREGADOR, ESTADO) %>%
    dplyr::count(ESTADO) %>%
      dplyr::mutate(
        ESTADO = forcats::fct_reorder(ESTADO, n)
      ) %>% 
        ggplot2::ggplot(ggplot2::aes(x = ESTADO, y = n)) +
          ggplot2::geom_col(fill = cores$azul_escuro) +
            ggplot2::geom_label(ggplot2::aes(x = ESTADO, y = n, label = n), fill = cores$verde_claro, color = cores$azul_escuro) +
              ggplot2::labs(x = "Estados", title  = "Quantidade de Entregadores por estado") +
                tema_semest_barra_x()

df_entregas %>%
  dplyr::distinct(ID_ENTREGADOR, ESTADO) %>%
    dplyr::count(ESTADO) %>%
      dplyr::left_join(
        df_entregas %>% 
          dplyr::group_by(ESTADO) %>% 
            dplyr::summarise(
              media_nota = round(mean(NOTA_ENTREGA, na.rm = TRUE),1)
            ), by = c("ESTADO" = "ESTADO")
) %>%
              dplyr::mutate(
              ESTADO = forcats::fct_reorder(ESTADO, dplyr::desc(n))
            ) %>% 
          ggplot2::ggplot(ggplot2::aes(x = media_nota, y = n, color = ESTADO)) +
            ggplot2::geom_point(size = 5) +
              ggplot2::theme_minimal() +
                ggplot2::labs(x = "Media da Nota de Avaliação da Entrega", y = "Quantidade de entregadores", title = "Quantidade de entregadores vs Média Nota Avaliação, por estado") +
                  ggplot2::scale_color_manual(values = cordegrade(5))

```

Em relação a quantidade de entregadores por cada estado:

- Não há uma relação evidente quanto entre a quantidade de entregadores e a média de nota de avaliação por estado

Porém, vamo verificar a quantidade de entregadores em relação ao volume de pedidos de cada estado

```{r echo=FALSE,message=FALSE, warning=FALSE, fig.align='center', fig.dim= c(10,4)}

df_entregas %>%
  dplyr::distinct(ID_ENTREGADOR, ESTADO) %>%
    dplyr::group_by(ESTADO) %>% 
      dplyr::summarise(
        Qtd_entregadores = dplyr::n()
      ) %>% 
dplyr::left_join(
      (df_entregas %>%
        dplyr::group_by(ESTADO) %>%  
          dplyr::summarise(
            Vol_entregas = dplyr::n(),
            media_nota = round(mean(NOTA_ENTREGA, na.rm = TRUE),1)
          )), by = c("ESTADO" = "ESTADO")
) %>% 
            dplyr::mutate(
              Media_entregador = round(Vol_entregas/Qtd_entregadores,1)
            ) %>%
              dplyr::arrange(dplyr::desc(Media_entregador)) %>% knitr::kable()




df_entregas %>%
  dplyr::distinct(ID_ENTREGADOR, ESTADO) %>%
    dplyr::group_by(ESTADO) %>% 
      dplyr::summarise(
        Qtd_entregadores = dplyr::n()
      ) %>% 
dplyr::left_join(
      (df_entregas %>%
        dplyr::group_by(ESTADO) %>%  
          dplyr::summarise(
            Vol_entregas = dplyr::n(),
            media_nota = round(mean(NOTA_ENTREGA, na.rm = TRUE),1)
          )), by = c("ESTADO" = "ESTADO")
) %>% 
            dplyr::mutate(
              Media_entregador = round(Vol_entregas/Qtd_entregadores,1),
              ESTADO = forcats::fct_reorder(ESTADO, dplyr::desc(Media_entregador))
            ) %>% 
          ggplot2::ggplot(ggplot2::aes(x = media_nota, y = Media_entregador, color = ESTADO)) +
            ggplot2::geom_point(size = 5) +
              ggplot2::theme_minimal() +
                ggplot2::labs(x = "Media da Nota de Avaliação da Entrega", y = "Media por Entregador", title = "Media por entregador vs Média Nota Avaliação, por estado") +
                  ggplot2::scale_color_manual(values = cordegrade(5))
    


```

